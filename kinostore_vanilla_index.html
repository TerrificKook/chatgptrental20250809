<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kinostore ¬∑ –ê—Ä–µ–Ω–¥–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞</title>

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–ª–∞—Å—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ Tailwind –∏–Ω–∞—á–µ –≤—ã–∫–∏–Ω–µ—Ç
    tailwind.config = {
      safelist: [
        'bg-gradient-to-r','bg-gradient-to-b','bg-gradient-to-br',
        'from-neutral-950','to-neutral-900',
        'from-black/10','to-black/60',
        'bg-white/5','bg-white/10','bg-black/30',
        'border-white/10','border-white/15',
        'text-white/60','text-white/70','bg-white','text-black',
        // –¶–≤–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        'from-pink-500','to-orange-500',
        'from-rose-500','to-fuchsia-500',
        'from-purple-500','to-indigo-500',
        'from-cyan-500','to-emerald-500',
        'from-sky-500','to-blue-600',
        'from-amber-500','to-red-500',
        'from-lime-500','to-emerald-500',
        'from-yellow-500','to-orange-600',
        'from-green-500','to-teal-500',
        'from-indigo-500','to-violet-600',
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã UI
        'from-amber-300','via-rose-400','to-fuchsia-400',
        'from-indigo-400','to-violet-600',
        'from-violet-400','to-fuchsia-600',
        'from-sky-400','to-blue-600',
        'from-emerald-400','to-lime-500',
        'from-fuchsia-400','to-amber-300'
      ]
    }
  </script>
  <style>
    .toast { position: fixed; top: 16px; right: 16px; z-index: 9999; }
    .shadow-deep { box-shadow: 0 20px 40px rgba(0,0,0,.35); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-neutral-950 to-neutral-900 text-white">
  <div id="toast" class="toast"></div>

  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-black/50 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <span class="text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-amber-300 via-rose-400 to-fuchsia-400">Kinostore</span>
      <span class="hidden sm:inline text-sm text-white/60">–ê—Ä–µ–Ω–¥–∞ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞ –¥–ª—è —Å—ä—ë–º–æ–∫ ‚Äî –ú–æ—Å–∫–≤–∞ –∏ –ú–û</span>
      <div class="ml-auto flex items-center gap-2">
        <button id="btn-add" class="px-3 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-lime-500 text-black font-semibold hover:brightness-110">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
        <a id="a-tg" href="https://t.me/mrdinar" target="_blank" class="px-3 py-2 rounded-xl bg-gradient-to-r from-violet-400 to-fuchsia-600 font-semibold hover:brightness-110">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
        <a id="a-wa" href="#" target="_blank" class="px-3 py-2 rounded-xl bg-gradient-to-r from-sky-400 to-blue-600 font-semibold hover:brightness-110">–ó–∞—è–≤–∫–∞ –≤ WhatsApp</a>
      </div>
    </div>
  </header>

  <!-- Search & filters -->
  <section class="max-w-7xl mx-auto px-4 py-6">
    <div class="rounded-2xl p-4 bg-white/5 ring-1 ring-white/10">
      <div class="flex flex-col sm:flex-row gap-3">
        <input id="inp-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –º–µ—Ç—Ä–æ, —Ä–∞–π–æ–Ω—É‚Ä¶" class="flex-1 rounded-xl bg-white/10 px-4 py-3 outline-none focus:ring-2 focus:ring-fuchsia-400" />
        <div class="flex gap-2">
          <input id="date-from" type="date" class="rounded-xl bg-white/10 px-3 py-3" />
          <input id="date-to" type="date" class="rounded-xl bg-white/10 px-3 py-3" />
        </div>
      </div>
      <div id="cats" class="mt-4 flex flex-wrap gap-2"></div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 -mt-2 pb-2">
    <button id="btn-metro" class="px-4 py-2 rounded-xl bg-gradient-to-r from-indigo-400 to-violet-600 font-semibold hover:brightness-110">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–µ—Ç—Ä–æ</button>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 pb-28">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>

  <!-- Cart -->
  <aside class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[min(96vw,980px)] z-40">
    <div class="rounded-2xl bg-white/10 backdrop-blur border border-white/15 shadow-deep">
      <div class="px-4 py-3 flex flex-wrap items-center gap-3">
        <span class="font-semibold">–í—ã–±—Ä–∞–Ω–æ: <span id="cart-count">0</span></span>
        <div id="cart-strip" class="flex-1 overflow-x-auto flex gap-3 py-1"></div>
        <div class="ml-auto font-bold">–ò—Ç–æ–≥–æ: <span id="cart-total">0 ‚ÇΩ</span></div>
        <a href="https://t.me/mrdinar" target="_blank" class="px-4 py-2 rounded-xl bg-gradient-to-r from-violet-400 to-fuchsia-600 font-semibold hover:brightness-110">–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</a>
        <a id="a-wa-bottom" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-gradient-to-r from-sky-400 to-blue-600 font-semibold hover:brightness-110">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</a>
        <button id="btn-checkout" class="px-4 py-2 rounded-xl bg-gradient-to-r from-emerald-400 to-lime-500 text-black font-semibold hover:brightness-110">–û–ø–ª–∞—Ç–∏—Ç—å –æ–Ω–ª–∞–π–Ω</button>
      </div>
    </div>
  </aside>

  <!-- How it works -->
  <section class="max-w-7xl mx-auto px-4 py-10">
    <div class="grid md:grid-cols-3 gap-6">
      <div class="rounded-2xl p-6 bg-gradient-to-br from-white/10 to-white/5 border border-white/10"><div class="text-3xl mb-2">üîé</div><div class="font-semibold text-lg">–í—ã–±–µ—Ä–∏—Ç–µ</div><div class="text-white/70">–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –º–µ—Ç—Ä–æ –∏–ª–∏ —Ä–∞–π–æ–Ω—É.</div></div>
      <div class="rounded-2xl p-6 bg-gradient-to-br from-white/10 to-white/5 border border-white/10"><div class="text-3xl mb-2">üìÖ</div><div class="font-semibold text-lg">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã</div><div class="text-white/70">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã: –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è –∏–ª–∏ –º–µ—Å—è—Ü.</div></div>
      <div class="rounded-2xl p-6 bg-gradient-to-br from-white/10 to-white/5 border border-white/10"><div class="text-3xl mb-2">üì®</div><div class="font-semibold text-lg">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É</div><div class="text-white/70">–ó–∞—è–≤–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —É—Ö–æ–¥–∏—Ç –≤ WhatsApp/Telegram.</div></div>
    </div>
    <p class="mt-6 text-white/60 text-sm">–î–µ–º–æ‚Äë–ø—Ä–æ–µ–∫—Ç. –¶–µ–Ω—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ; –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —É—Ç–æ—á–Ω—è–π—Ç–µ —É –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</p>
  </section>

  <!-- Modal root -->
  <div id="modal-root"></div>

  <script>
    // ======= Data & helpers =======
    const CATEGORIES = [
      { key: 'furniture', name: '–ú–µ–±–µ–ª—å –∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä', emoji: 'üõãÔ∏è', color: 'from-pink-500 to-orange-500' },
      { key: 'decor', name: '–î–µ–∫–æ—Ä –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã', emoji: 'üéÄ', color: 'from-rose-500 to-fuchsia-500' },
      { key: 'costumes', name: '–ö–æ—Å—Ç—é–º—ã –∏ –æ–¥–µ–∂–¥–∞', emoji: 'üëó', color: 'from-purple-500 to-indigo-500' },
      { key: 'props', name: '–†–µ–∫–≤–∏–∑–∏—Ç —Å–ø–µ—Ü.', emoji: 'üé¨', color: 'from-cyan-500 to-emerald-500' },
      { key: 'tech', name: '–¢–µ—Ö–Ω–∏–∫–∞ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', emoji: 'üì∏', color: 'from-sky-500 to-blue-600' },
      { key: 'locations', name: '–õ–æ–∫–∞—Ü–∏–∏ –∏ –ø–ª–æ—â–∞–¥–∫–∏', emoji: 'üìç', color: 'from-amber-500 to-red-500' },
      { key: 'transport', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', emoji: 'üöó', color: 'from-lime-500 to-emerald-500' },
      { key: 'catering', name: '–ö–µ–π—Ç–µ—Ä–∏–Ω–≥', emoji: 'üçΩÔ∏è', color: 'from-yellow-500 to-orange-600' },
      { key: 'animals', name: '–ñ–∏–≤–æ—Ç–Ω—ã–µ', emoji: 'üêæ', color: 'from-green-500 to-teal-500' },
      { key: 'lighting', name: '–°–≤–µ—Ç–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', emoji: 'üí°', color: 'from-indigo-500 to-violet-600' },
    ];

    function rub(n){ return new Intl.NumberFormat('ru-RU').format(n) + ' ‚ÇΩ' }
    function daysBetween(a,b){ return Math.max(1, Math.ceil((new Date(b) - new Date(a)) / (1000*60*60*24))) }

    const SAMPLE = [
      {id:'f1',cat:'furniture',title:'–ö—Ä–µ—Å–ª–æ –∏–∑ 60-—Ö',metro:'–¢–∞–≥–∞–Ω—Å–∫–∞—è',area:'–ú–æ—Å–∫. —Ü–µ–Ω—Ç—Ä',priceDay:2500,priceWeek:14000,priceMonth:48000,img:'https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=1200&auto=format&fit=crop'},
      {id:'f2',cat:'furniture',title:'–î–∏–≤–∞–Ω –±–∞—Ä—Ö–∞—Ç–Ω—ã–π',metro:'–°–∞–≤—ë–ª–æ–≤—Å–∫–∞—è',area:'–°–ê–û',priceDay:3200,priceWeek:17500,priceMonth:60000,img:'https://images.unsplash.com/photo-1549187774-b4e9b0445b41?q=80&w=1200&auto=format&fit=crop'},
      {id:'f3',cat:'furniture',title:'–°—Ç–æ–ª –ª–æ—Ñ—Ç 180√ó90',metro:'–ë–∞—É–º–∞–Ω—Å–∫–∞—è',area:'–¶–ê–û',priceDay:1800,priceWeek:9800,priceMonth:34000,img:'https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=1200&auto=format&fit=crop'},
      {id:'d1',cat:'decor',title:'–ù–∞–ø–æ–ª—å–Ω–∞—è –≤–∞–∑–∞',metro:'–ü–∞–≤–µ–ª–µ—Ü–∫–∞—è',area:'–¶–ê–û',priceDay:700,priceWeek:3600,priceMonth:12000,img:'https://images.unsplash.com/photo-1600460351480-8b2f0b4a9f63?q=80&w=1200&auto=format&fit=crop'},
      {id:'d2',cat:'decor',title:'–ö–∞—Ä—Ç–∏–Ω–∞ ¬´–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è¬ª',metro:'–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è',area:'–¶–ê–û',priceDay:1500,priceWeek:7800,priceMonth:26000,img:'https://images.unsplash.com/photo-1513364776144-60967b0f800f?q=80&w=1200&auto=format&fit=crop'},
      {id:'d3',cat:'decor',title:'–ì–∏—Ä–ª—è–Ω–¥–∞ —Ä–µ—Ç—Ä–æ',metro:'–ö–∞–ª—É–∂—Å–∫–∞—è',area:'–Æ–ó–ê–û',priceDay:600,priceWeek:3000,priceMonth:9000,img:'https://images.unsplash.com/photo-1478147427282-58a87a120781?q=80&w=1200&auto=format&fit=crop'},
      {id:'c1',cat:'costumes',title:'–ü–ª–∞—Ç—å–µ 20-—Ö',metro:'–ú–∞—è–∫–æ–≤—Å–∫–∞—è',area:'–¶–ê–û',priceDay:2200,priceWeek:12000,priceMonth:40000,img:'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1200&auto=format&fit=crop'},
      {id:'c2',cat:'costumes',title:'–ö–æ—Å—Ç—é–º –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ (—Ä–µ—Ç—Ä–æ)',metro:'–°–æ–∫–æ–ª',area:'–°–ê–û',priceDay:1900,priceWeek:10500,priceMonth:35000,img:'https://images.unsplash.com/photo-1511632765486-a01980e01a18?q=80&w=1200&auto=format&fit=crop'},
      {id:'c3',cat:'costumes',title:'–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç (–º—É–ª—è–∂)',metro:'–ü–µ—á–∞—Ç–Ω–∏–∫–∏',area:'–Æ–í–ê–û',priceDay:1200,priceWeek:6500,priceMonth:22000,img:'https://images.unsplash.com/photo-1593614209215-1b92b1739f19?q=80&w=1200&auto=format&fit=crop'},
      {id:'p1',cat:'props',title:'–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —á–µ–º–æ–¥–∞–Ω',metro:'–ö–æ–ª–æ–º–µ–Ω—Å–∫–∞—è',area:'–Æ–ê–û',priceDay:900,priceWeek:4800,priceMonth:16000,img:'https://images.unsplash.com/photo-1584982751601-97dcc096659c?q=80&w=1200&auto=format&fit=crop'},
      {id:'p2',cat:'props',title:'–°–∞–∫—Å–æ—Ñ–æ–Ω (–º—É–ª—è–∂)',metro:'–ö—É–∑—å–º–∏–Ω–∫–∏',area:'–Æ–í–ê–û',priceDay:1400,priceWeek:7600,priceMonth:25000,img:'https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?q=80&w=1200&auto=format&fit=crop'},
      {id:'p3',cat:'props',title:'–í–∏–Ω—Ç–∞–∂–Ω–∞—è –∫–∏–Ω–æ–∫–∞–º–µ—Ä–∞',metro:'–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è',area:'–¶–ê–û',priceDay:2400,priceWeek:13000,priceMonth:42000,img:'https://images.unsplash.com/photo-1497032628192-86f99bcd76bc?q=80&w=1200&auto=format&fit=crop'},
      {id:'t1',cat:'tech',title:'–¢–µ–ª–µ–≤–∏–∑–æ—Ä –≠–õ–¢',metro:'–í–î–ù–•',area:'–°–í–ê–û',priceDay:1600,priceWeek:8800,priceMonth:30000,img:'https://images.unsplash.com/photo-1518432031352-d6fc5c10da5a?q=80&w=1200&auto=format&fit=crop'},
      {id:'t2',cat:'tech',title:'–ö–∞—Å—Å–æ–≤—ã–π –∞–ø–ø–∞—Ä–∞—Ç —Ä–µ—Ç—Ä–æ',metro:'–ö–∏—Ç–∞–π-–≥–æ—Ä–æ–¥',area:'–¶–ê–û',priceDay:1300,priceWeek:7000,priceMonth:23000,img:'https://images.unsplash.com/photo-1526308182278-10f98dea4d2a?q=80&w=1200&auto=format&fit=crop'},
      {id:'t3',cat:'tech',title:'–ù–æ—É—Ç–±—É–∫ —É–ª—å—Ç—Ä–∞–±—É–∫',metro:'–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è',area:'–¶–ê–û',priceDay:2000,priceWeek:11000,priceMonth:36000,img:'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop'},
      {id:'l1',cat:'locations',title:'–°—Ç—É–¥–∏–π–Ω–∞—è –≥–æ—Å—Ç–∏–Ω–∞—è',metro:'–î–∏–Ω–∞–º–æ',area:'–°–ê–û',priceDay:18000,priceWeek:98000,priceMonth:320000,img:'https://images.unsplash.com/photo-1505691938895-1758d7feb511?q=80&w=1200&auto=format&fit=crop'},
      {id:'l2',cat:'locations',title:'–ö–∞—Ñ–µ-—É–≥–æ–ª–æ–∫',metro:'–ê—Ä–±–∞—Ç—Å–∫–∞—è',area:'–¶–ê–û',priceDay:22000,priceWeek:120000,priceMonth:390000,img:'https://images.unsplash.com/photo-1498654200943-1088dd4438ae?q=80&w=1200&auto=format&fit=crop'},
      {id:'l3',cat:'locations',title:'–°—Ç—É–¥–∏—è —Å —Ü–∏–∫–ª–æ—Ä–∞–º–æ–π',metro:'–¢–µ–∫—Å—Ç–∏–ª—å—â–∏–∫–∏',area:'–Æ–í–ê–û',priceDay:25000,priceWeek:140000,priceMonth:450000,img:'https://images.unsplash.com/photo-1526312426976-593c2a270bd5?q=80&w=1200&auto=format&fit=crop'},
      {id:'tr1',cat:'transport',title:'–õ–∞–¥–∞ 2106 (–±–µ–∂)',metro:'–ö—É–Ω—Ü–µ–≤—Å–∫–∞—è',area:'–ó–ê–û',priceDay:12000,priceWeek:65000,priceMonth:210000,img:'https://images.unsplash.com/photo-1609669347085-017076bf20c6?q=80&w=1200&auto=format&fit=crop'},
      {id:'tr2',cat:'transport',title:'–°–∫—É—Ç–µ—Ä —Ä–µ—Ç—Ä–æ',metro:'–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è',area:'–¶–ê–û',priceDay:3500,priceWeek:19000,priceMonth:60000,img:'https://images.unsplash.com/photo-1502877338535-766e1452684a?q=80&w=1200&auto=format&fit=crop'},
      {id:'tr3',cat:'transport',title:'–í–µ–ª–æ—Å–∏–ø–µ–¥ —à–æ—Å—Å–µ–π–Ω—ã–π',metro:'–ë–µ–≥–æ–≤–∞—è',area:'–°–ê–û',priceDay:2000,priceWeek:11000,priceMonth:36000,img:'https://images.unsplash.com/photo-1517649763962-0c623066013b?q=80&w=1200&auto=format&fit=crop'},
      {id:'k1',cat:'catering',title:'–ö–æ—Ñ–µ–º–∞—à–∏–Ω–∞ —ç—Å–ø—Ä–µ—Å—Å–æ',metro:'–°—É—Ö–∞—Ä–µ–≤—Å–∫–∞—è',area:'–¶–ê–û',priceDay:2800,priceWeek:15000,priceMonth:50000,img:'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop'},
      {id:'k2',cat:'catering',title:'–°—Ç–æ–ª —Å–µ—Ä–≤–∏—Ä–æ–≤–æ—á–Ω—ã–π',metro:'–¢–µ—Ö–Ω–æ–ø–∞—Ä–∫',area:'–Æ–ê–û',priceDay:900,priceWeek:4800,priceMonth:16000,img:'https://images.unsplash.com/photo-1467348733814-f93fc480bec6?q=80&w=1200&auto=format&fit=crop'},
      {id:'k3',cat:'catering',title:'–ú–µ–Ω—é-–¥–æ—Å–∫–∞ –º–µ–ª–æ–≤–∞—è',metro:'–¢–≤–µ—Ä—Å–∫–∞—è',area:'–¶–ê–û',priceDay:600,priceWeek:3200,priceMonth:10000,img:'https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1200&auto=format&fit=crop'},
      {id:'a1',cat:'animals',title:'–•–∞—Å–∫–∏ –æ–±—É—á–µ–Ω–Ω—ã–π (—Å —Ö–µ–Ω–¥–ª–µ—Ä–æ–º)',metro:'–©—ë–ª–∫–æ–≤—Å–∫–∞—è',area:'–í–ê–û',priceDay:15000,priceWeek:80000,priceMonth:260000,img:'https://images.unsplash.com/photo-1543466835-00a7907e9de1?q=80&w=1200&auto=format&fit=crop'},
      {id:'a2',cat:'animals',title:'–ö–æ—à–∫–∞-–º–æ–¥–µ–ª—å (—Å —Ö–µ–Ω–¥–ª–µ—Ä–æ–º)',metro:'–ò–∑–º–∞–π–ª–æ–≤–æ',area:'–í–ê–û',priceDay:9000,priceWeek:48000,priceMonth:160000,img:'https://images.unsplash.com/photo-1533738363-b7f9aef128ce?q=80&w=1200&auto=format&fit=crop'},
      {id:'a3',cat:'animals',title:'–ü–æ–ø—É–≥–∞–π –∞—Ä–∞ (—Å —Ö–µ–Ω–¥–ª–µ—Ä–æ–º)',metro:'–†–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª',area:'–°–ê–û',priceDay:12000,priceWeek:65000,priceMonth:210000,img:'https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=1200&auto=format&fit=crop'},
      {id:'s1',cat:'lighting',title:'LED-–ø–∞–Ω–µ–ª—å 1√ó1',metro:'–û—Ö–æ—Ç–Ω—ã–π —Ä—è–¥',area:'–¶–ê–û',priceDay:1600,priceWeek:8800,priceMonth:30000,img:'https://images.unsplash.com/photo-1507473885765-e6ed057f782c?q=80&w=1200&auto=format&fit=crop'},
      {id:'s2',cat:'lighting',title:'–°–æ—Ñ—Ç–±–æ–∫—Å 60√ó90 + —Å—Ç–æ–π–∫–∞',metro:'–ù–∞–≥–∞—Ç–∏–Ω—Å–∫–∞—è',area:'–Æ–ê–û',priceDay:1200,priceWeek:6500,priceMonth:22000,img:'https://images.unsplash.com/photo-1516035069371-29a1b244cc32?q=80&w=1200&auto=format&fit=crop'},
      {id:'s3',cat:'lighting',title:'–ñ—É—Ä–∞–≤–ª—å + —à—Ç–∞–Ω–≥–∞',metro:'–ö–∏–µ–≤—Å–∫–∞—è',area:'–ó–ê–û',priceDay:1900,priceWeek:10500,priceMonth:35000,img:'https://images.unsplash.com/photo-1452587925148-ce544e77e70d?q=80&w=1200&auto=format&fit=crop'}
    ];

    const LS_KEY = 'kinostore:listings:v1';

    const state = {
      q: '', cat: 'all', from: '', to: '',
      selected: {}, // id -> { term: 'day'|'week'|'month' }
      listings: []
    };

    // ======= Boot =======
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const extra = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        state.listings = Array.isArray(extra) ? [...SAMPLE, ...extra] : [...SAMPLE];
      } catch { state.listings = [...SAMPLE]; }

      bindControls();
      renderCategories();
      renderAll();
      checkHashToast();
      window.addEventListener('hashchange', checkHashToast);
      selfTests();
    });

    // ======= Rendering =======
    function renderCategories(){
      const wrap = document.getElementById('cats');
      const parts = [
        `<button data-cat="all" class="px-3 py-1.5 rounded-full text-sm border ${state.cat==='all'?'bg-white text-black border-transparent':'border-white/20 hover:bg-white/10'}">–í—Å–µ</button>`
      ];
      for(const c of CATEGORIES){
        const active = state.cat===c.key;
        const cls = active ? `text-black border-transparent bg-gradient-to-r ${c.color}` : 'border-white/20 hover:bg-white/10';
        parts.push(`<button data-cat="${c.key}" class="px-3 py-1.5 rounded-full text-sm border transition ${cls}">${c.emoji} ${c.name}</button>`);
      }
      wrap.innerHTML = parts.join('');
    }

    function getFiltered(){
      const q = state.q.trim().toLowerCase();
      return state.listings.filter(it => {
        const okCat = state.cat==='all' || it.cat===state.cat;
        const text = (it.title+" "+it.metro+" "+it.area).toLowerCase();
        const okQ = !q || text.includes(q);
        return okCat && okQ;
      });
    }

    function renderGrid(){
      const grid = document.getElementById('grid');
      const items = getFiltered();
      grid.innerHTML = items.map(it => cardHTML(it)).join('');
    }

    function cardHTML(it){
      const catMeta = CATEGORIES.find(c=>c.key===it.cat);
      const selected = !!state.selected[it.id];
      return `
        <div class="group relative overflow-hidden rounded-3xl border border-white/10 bg-white/5">
          <div class="absolute inset-0 bg-gradient-to-b from-black/10 to-black/60 opacity-0 group-hover:opacity-100 transition"></div>
          <img src="${it.img}" alt="${escapeHtml(it.title)}" class="h-56 w-full object-cover"/>
          <div class="p-4 space-y-3">
            <div class="flex items-center gap-2 text-xs">
              <span class="px-2 py-1 rounded-full font-semibold text-black bg-gradient-to-r ${catMeta?.color||''}">${catMeta?.emoji||''} ${catMeta?.name||''}</span>
              <span class="px-2 py-1 rounded-full bg-white/10">üöá ${it.metro}</span>
              <span class="px-2 py-1 rounded-full bg-white/10">üìç ${it.area}</span>
            </div>
            <h3 class="text-lg font-bold leading-tight">${escapeHtml(it.title)}</h3>
            <div class="flex items-end gap-4">
              ${priceHTML('–¥–µ–Ω—å', it.priceDay)}
              ${priceHTML('–Ω–µ–¥–µ–ª—è', it.priceWeek)}
              ${priceHTML('–º–µ—Å—è—Ü', it.priceMonth)}
            </div>
            <div class="flex items-center gap-2">
              <button data-action="toggle" data-id="${it.id}" class="px-3 py-2 rounded-xl font-semibold ${selected?'bg-white text-black':'bg-gradient-to-r from-fuchsia-400 to-amber-300 text-black'}">${selected?'–£–±—Ä–∞—Ç—å':'–í—ã–±—Ä–∞—Ç—å'}</button>
              ${selected ? `
                <select data-action="term" data-id="${it.id}" class="rounded-xl bg-white/10 px-2 py-2">
                  <option value="day" ${getTerm(it.id)==='day'?'selected':''}>–¥–µ–Ω—å</option>
                  <option value="week" ${getTerm(it.id)==='week'?'selected':''}>–Ω–µ–¥–µ–ª—è</option>
                  <option value="month" ${getTerm(it.id)==='month'?'selected':''}>–º–µ—Å—è—Ü</option>
                </select>` : ''}
            </div>
          </div>
        </div>`;
    }

    function priceHTML(label, value){
      return `<div class="text-sm"><div class="text-white/60">${label}</div><div class="font-bold">${rub(value)}</div></div>`
    }

    function renderCart(){
      const strip = document.getElementById('cart-strip');
      const ids = Object.keys(state.selected);
      const items = ids.map(id => state.listings.find(x=>x.id===id)).filter(Boolean);
      strip.innerHTML = items.map(it => `
        <div class="flex items-center gap-2 bg-black/30 rounded-xl px-2 py-1">
          <img src="${it.img}" class="w-10 h-10 object-cover rounded-lg"/>
          <span class="text-sm whitespace-nowrap">${escapeHtml(it.title)}</span>
          <select data-action="term" data-id="${it.id}" class="text-sm bg-white/10 rounded-lg px-2 py-1 outline-none">
            <option value="day" ${getTerm(it.id)==='day'?'selected':''}>–¥–µ–Ω—å</option>
            <option value="week" ${getTerm(it.id)==='week'?'selected':''}>–Ω–µ–¥–µ–ª—è</option>
            <option value="month" ${getTerm(it.id)==='month'?'selected':''}>–º–µ—Å—è—Ü</option>
          </select>
          <button data-action="remove" data-id="${it.id}" class="text-white/60 hover:text-white">‚úï</button>
        </div>`).join('');
      document.getElementById('cart-count').textContent = items.length;
      document.getElementById('cart-total').textContent = rub(calcTotal(items));
      updateShareLinks(items);
    }

    function calcTotal(items){
      const d = state.from && state.to ? daysBetween(state.from, state.to) : 1;
      return items.reduce((sum, it)=>{
        const term = getTerm(it.id);
        if(term==='day') return sum + it.priceDay * d;
        if(term==='week') return sum + it.priceWeek * Math.ceil(d/7);
        return sum + it.priceMonth * Math.ceil(d/30);
      }, 0);
    }

    function renderAll(){
      renderGrid();
      renderCart();
    }

    function getTerm(id){ return (state.selected[id]?.term) || 'day'; }

    // ======= Events & controls =======
    function bindControls(){
      document.getElementById('inp-search').addEventListener('input', (e)=>{ state.q=e.target.value; renderAll(); });
      document.getElementById('date-from').addEventListener('change', e=>{ state.from=e.target.value; renderCart(); });
      document.getElementById('date-to').addEventListener('change', e=>{ state.to=e.target.value; renderCart(); });

      document.getElementById('cats').addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-cat]');
        if(!btn) return; state.cat = btn.dataset.cat; renderCategories(); renderGrid();
      });

      document.getElementById('grid').addEventListener('click', onGridClick);
      document.getElementById('grid').addEventListener('change', onTermChange);
      document.getElementById('cart-strip').addEventListener('click', onCartClick);
      document.getElementById('cart-strip').addEventListener('change', onTermChange);

      document.getElementById('btn-metro').addEventListener('click', openMetroModal);
      document.getElementById('btn-add').addEventListener('click', openCreateModal);
      document.getElementById('btn-checkout').addEventListener('click', openCheckoutModal);
    }

    function onGridClick(e){
      const t = e.target.closest('[data-action]'); if(!t) return;
      const id = t.dataset.id; const act = t.dataset.action;
      if(act==='toggle'){
        state.selected[id] = state.selected[id] ? undefined : {term:'day'};
        if(state.selected[id]===undefined) delete state.selected[id];
        renderAll();
      }
    }
    function onCartClick(e){
      const t = e.target.closest('[data-action]'); if(!t) return;
      const id = t.dataset.id; const act = t.dataset.action;
      if(act==='remove'){ delete state.selected[id]; renderAll(); }
    }
    function onTermChange(e){
      const t = e.target; if(t.matches('[data-action="term"]')){
        const id = t.dataset.id; state.selected[id] = { term: t.value }; renderCart();
      }
    }

    // ======= Modals =======
    function openMetroModal(){
      const LINES = [
        { key:'red',   name:'–°–æ–∫–æ–ª—å–Ω–∏—á–µ—Å–∫–∞—è', color:'bg-red-500',    stations:['–ë—É–ª—å–≤–∞—Ä –†–æ–∫–æ—Å—Å–æ–≤—Å–∫–æ–≥–æ','–ß–µ—Ä–∫–∏–∑–æ–≤—Å–∫–∞—è','–ü—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–∞—è –ø–ª–æ—â–∞–¥—å','–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è','–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è','–ö—Ä–∞—Å–Ω—ã–µ –í–æ—Ä–æ—Ç–∞','–ß–∏—Å—Ç—ã–µ –ø—Ä—É–¥—ã','–õ—É–±—è–Ω–∫–∞','–û—Ö–æ—Ç–Ω—ã–π —Ä—è–¥','–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–º. –õ–µ–Ω–∏–Ω–∞','–ü–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã'] },
        { key:'green', name:'–ó–∞–º–æ—Å–∫–≤–æ—Ä–µ—Ü–∫–∞—è',  color:'bg-green-500',  stations:['–•–æ–≤—Ä–∏–Ω–æ','–ë–µ–ª–æ–º–æ—Ä—Å–∫–∞—è','–†–µ—á–Ω–æ–π –≤–æ–∫–∑–∞–ª','–í–æ–¥–Ω—ã–π —Å—Ç–∞–¥–∏–æ–Ω','–í–æ–π–∫–æ–≤—Å–∫–∞—è','–°–æ–∫–æ–ª','–ê—ç—Ä–æ–ø–æ—Ä—Ç','–î–∏–Ω–∞–º–æ','–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è','–ú–∞—è–∫–æ–≤—Å–∫–∞—è','–¢–≤–µ—Ä—Å–∫–∞—è','–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è','–ù–æ–≤–æ–∫—É–∑–Ω–µ—Ü–∫–∞—è','–ü–∞–≤–µ–ª–µ—Ü–∫–∞—è'] },
        { key:'brown', name:'–ö–æ–ª—å—Ü–µ–≤–∞—è',       color:'bg-amber-700',  stations:['–ü–∞—Ä–∫ –∫—É–ª—å—Ç—É—Ä—ã','–û–∫—Ç—è–±—Ä—å—Å–∫–∞—è','–î–æ–±—Ä—ã–Ω–∏–Ω—Å–∫–∞—è','–ü–∞–≤–µ–ª–µ—Ü–∫–∞—è','–¢–∞–≥–∞–Ω—Å–∫–∞—è','–ö—É—Ä—Å–∫–∞—è','–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è','–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∏—Ä–∞','–ù–æ–≤–æ—Å–ª–æ–±–æ–¥—Å–∫–∞—è','–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è','–ö—Ä–∞—Å–Ω–æ–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∞—è','–ö–∏–µ–≤—Å–∫–∞—è'] },
      ];
      let active = 'red';
      const root = document.getElementById('modal-root');
      root.innerHTML = modalShell(`
        <div class="w-[min(96vw,980px)] h-[min(90vh,720px)] rounded-3xl bg-neutral-900 border border-white/10 overflow-hidden grid md:grid-cols-3">
          <div class="md:col-span-1 border-r border-white/10 p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-bold">–°—Ö–µ–º–∞ –º–µ—Ç—Ä–æ</div>
              <button data-x class="text-white/70 hover:text-white">‚úï</button>
            </div>
            <div class="space-y-2" id="metro-lines"></div>
          </div>
          <div class="md:col-span-2 flex flex-col">
            <div class="p-4 border-b border-white/10 text-white/70">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é ‚Äî –º—ã –ø–æ–¥—Å—Ç–∞–≤–∏–º –µ—ë –≤ –ø–æ–∏—Å–∫.</div>
            <div class="flex-1 overflow-auto p-4 grid sm:grid-cols-2 gap-2" id="metro-stations"></div>
            <div class="p-4 border-t border-white/10 flex items-center gap-2">
              <input id="metro-input" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é‚Ä¶" class="flex-1 rounded-xl bg-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-fuchsia-400"/>
              <a href="https://mosmetro.ru/map/" target="_blank" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</a>
            </div>
          </div>
        </div>`);

      function paint(){
        const lines = document.getElementById('metro-lines');
        lines.innerHTML = LINES.map(l=>`<button data-line="${l.key}" class="w-full flex items-center gap-2 px-3 py-2 rounded-xl ${active===l.key?'bg-white/15':'bg-white/5 hover:bg-white/10'}"><span class="inline-block w-3 h-3 rounded-full ${l.color}"></span><span class="text-left flex-1">${l.name}</span></button>`).join('');
        const cur = LINES.find(l=>l.key===active);
        document.getElementById('metro-stations').innerHTML = cur.stations.map(st=>`<button data-st="${st}" class="text-left px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15">${st}</button>`).join('');
      }
      paint();

      root.addEventListener('click', onClick);
      function onClick(e){
        if(e.target.matches('[data-x]') || e.target.closest('[data-overlay]')){ close(); return; }
        const line = e.target.closest('[data-line]'); if(line){ active=line.dataset.line; paint(); return; }
        const st = e.target.closest('[data-st]');   if(st){ state.q=st.dataset.st; document.getElementById('inp-search').value=state.q; renderAll(); close(); }
      }
      document.getElementById('metro-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && e.target.value){ state.q=e.target.value; document.getElementById('inp-search').value=state.q; renderAll(); close(); }});

      function close(){ root.innerHTML=''; root.removeEventListener('click', onClick); }
    }

    function openCreateModal(){
      const id = 'u'+Date.now();
      const root = document.getElementById('modal-root');
      root.innerHTML = modalShell(`
        <div class="w-[min(96vw,680px)] rounded-3xl bg-neutral-900 border border-white/10 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
            <button data-x class="text-white/70 hover:text-white">‚úï</button>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            ${inputField('–ù–∞–∑–≤–∞–Ω–∏–µ','title')}
            ${selectField('–ö–∞—Ç–µ–≥–æ—Ä–∏—è','cat', CATEGORIES.map(c=>({value:c.key,label:c.name})))}
            ${inputField('–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ','img')}
            ${inputField('–ú–µ—Ç—Ä–æ','metro')}
            ${inputField('–†–∞–π–æ–Ω','area')}
            ${numberField('–¶–µ–Ω–∞/–¥–µ–Ω—å','priceDay')}
            ${numberField('–¶–µ–Ω–∞/–Ω–µ–¥–µ–ª—è','priceWeek')}
            ${numberField('–¶–µ–Ω–∞/–º–µ—Å—è—Ü','priceMonth')}
          </div>
          <div class="mt-4 flex gap-2 justify-end">
            <button data-x class="px-4 py-2 rounded-xl bg-white/10">–û—Ç–º–µ–Ω–∞</button>
            <button id="btn-save-item" class="px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-emerald-400 to-lime-500 text-black">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>`);

      document.getElementById('btn-save-item').addEventListener('click', ()=>{
        const v = (name)=> document.querySelector(`[name="${name}"]`).value.trim();
        const item = { id, title: v('title'), img: v('img'), metro: v('metro'), area: v('area'), cat: v('cat')||'furniture', priceDay: +v('priceDay')||0, priceWeek: +v('priceWeek')||0, priceMonth: +v('priceMonth')||0 };
        if(!item.title || !item.img || !item.priceDay){ showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω–∏–º—É–º: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ñ–æ—Ç–æ, —Ü–µ–Ω—É/–¥–µ–Ω—å', false); return; }
        const extras = JSON.parse(localStorage.getItem(LS_KEY)||'[]'); extras.push(item); localStorage.setItem(LS_KEY, JSON.stringify(extras));
        state.listings.push(item); renderAll(); close();
      });

      root.addEventListener('click', (e)=>{ if(e.target.matches('[data-x]') || e.target.closest('[data-overlay]')) close(); });
      function close(){ root.innerHTML=''; }
    }

    function openCheckoutModal(){
      const items = Object.keys(state.selected).map(id=> state.listings.find(i=>i.id===id)).filter(Boolean);
      const total = calcTotal(items);
      const root = document.getElementById('modal-root');
      root.innerHTML = modalShell(`
        <div class="w-[min(96vw,720px)] rounded-3xl bg-neutral-900 border border-white/10 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h3>
            <button data-x class="text-white/70 hover:text-white">‚úï</button>
          </div>
          <div class="space-y-3">
            <div class="text-sm text-white/70">–ü–æ–∑–∏—Ü–∏–∏ (${items.length}): ${items.map(i=>escapeHtml(i.title)).join(', ')}</div>
            <div class="font-semibold">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: ${rub(total)}</div>
            <div class="grid sm:grid-cols-2 gap-3">
              ${inputField('–ò–º—è','name')}
              ${inputField('–¢–µ–ª–µ—Ñ–æ–Ω','phone')}
              ${inputField('Email (–∫–≤–∏—Ç–∞–Ω—Ü–∏—è)','email')}
              ${selectField('–ü—Ä–æ–≤–∞–π–¥–µ—Ä –æ–ø–ª–∞—Ç—ã','provider', [{value:'tinkoff',label:'–¢–∏–Ω—å–∫–æ—Ñ—Ñ'},{value:'yookassa',label:'–ÆKassa'},{value:'stripe',label:'Stripe'}])}
            </div>
            <div class="text-sm text-white/60">–î–µ–º–æ-—Ä–µ–∂–∏–º: –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ¬´—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞¬ª, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–µ—Ä–Ω—ë—Ç—Å—è —è–∫–æ—Ä–µ–º.</div>
            <div class="flex justify-end gap-2">
              <button data-x class="px-4 py-2 rounded-xl bg-white/10">–û—Ç–º–µ–Ω–∞</button>
              <button id="btn-pay" class="px-4 py-2 rounded-xl font-semibold bg-gradient-to-r from-emerald-400 to-lime-500 text-black">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
          </div>
        </div>`);

      document.getElementById('btn-pay').addEventListener('click', ()=>{
        const v = (n)=> document.querySelector(`[name="${n}"]`).value.trim();
        const customer = {name:v('name'), phone:v('phone'), email:v('email')};
        const provider = v('provider')||'tinkoff';
        const payload = buildPaymentPayload({ provider, items, total, customer, redirectUrl: location.pathname + '#payment-success' });
        createInvoice(payload).then(url=>{ location.href = url; });
      });

      root.addEventListener('click', (e)=>{ if(e.target.matches('[data-x]') || e.target.closest('[data-overlay]')) close(); });
      function close(){ root.innerHTML=''; }
    }

    function modalShell(inner){
      return `<div data-overlay class="fixed inset-0 bg-black/70 backdrop-blur z-50 flex items-center justify-center p-4">${inner}</div>`;
    }

    function inputField(label,name){
      return `<label class="space-y-1"><div class="text-sm text-white/70">${label}</div><input name="${name}" class="w-full rounded-xl bg-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-fuchsia-400"/></label>`;
    }
    function numberField(label,name){
      return `<label class="space-y-1"><div class="text-sm text-white/70">${label}</div><input type="number" name="${name}" class="w-full rounded-xl bg-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-fuchsia-400"/></label>`;
    }
    function selectField(label,name,options){
      return `<label class="space-y-1"><div class="text-sm text-white/70">${label}</div><select name="${name}" class="w-full rounded-xl bg-white/10 px-3 py-2 outline-none">${options.map(o=>`<option value="${o.value}">${o.label}</option>`).join('')}</select></label>`;
    }

    // ======= Share/Toast/Payment stubs =======
    function updateShareLinks(items){
      const s = [
        '–ó–∞—è–≤–∫–∞ —Å Kinostore (–¥–µ–º–æ):',
        state.from && state.to ? `–î–∞—Ç—ã: ${state.from} ‚Äî ${state.to}` : '–î–∞—Ç–∞: –æ–¥–∏–Ω –¥–µ–Ω—å',
        ...items.map(it=>`‚Ä¢ ${it.title} ‚Äî ${getTerm(it.id)}`),
        `–ò—Ç–æ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ: ${rub(calcTotal(items))}`,
      ].join('\n');
      const wa = `https://wa.me/?text=${encodeURIComponent(s)}`;
      document.getElementById('a-wa').href = wa;
      document.getElementById('a-wa-bottom').href = wa;
    }

    function showToast(msg, ok=true){
      const el = document.getElementById('toast');
      el.innerHTML = `<div class="${ok?'bg-emerald-500 text-black':'bg-white/10 text-white'} rounded-xl px-4 py-2 shadow-deep">${msg}</div>`;
      setTimeout(()=> el.innerHTML='', 3000);
    }

    function checkHashToast(){
      if(location.hash==='#payment-success') showToast('–û–ø–ª–∞—Ç–∞ (–¥–µ–º–æ): —É—Å–ø–µ—Ö', true);
      if(location.hash==='#payment-fail') showToast('–û–ø–ª–∞—Ç–∞ (–¥–µ–º–æ): –æ—Ç–º–µ–Ω–∞/–æ—à–∏–±–∫–∞', false);
    }

    function buildPaymentPayload({provider='tinkoff', items=[], total=0, customer={}, redirectUrl=location.pathname + '#payment-success'}){
      return {
        provider,
        total,
        currency: 'RUB',
        orderId: 'KIN-' + Date.now(),
        description: `Kinostore: ${items.length} –ø–æ–∑.`,
        items: items.map(i=>({ name: i.title, price: i.priceDay || i.priceWeek || i.priceMonth || 0, quantity: 1 })),
        customer,
        redirectUrl,
      };
    }

    async function createInvoice(payload){
      // –§—Ä–æ–Ω—Ç–µ–Ω–¥-–∑–∞–≥–ª—É—à–∫–∞: –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏
      const success = location.pathname + '#payment-success';
      const fail = location.pathname + '#payment-fail';
      const html = `<!doctype html><html lang="ru"><meta charset="utf-8"><title>Demo Checkout ¬∑ ${payload.provider}</title>
      <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0b0b0c;color:#fff;margin:0}
      .wrap{max-width:760px;margin:40px auto;padding:24px;border:1px solid #ffffff22;border-radius:16px;background:linear-gradient(180deg,#111,#0b0b0c)}h1{margin:0 0 12px;font-size:22px}
      .btn{display:inline-block;margin-right:8px;padding:12px 16px;border-radius:12px;text-decoration:none;font-weight:700}
      .ok{background:linear-gradient(90deg,#34d399,#a3e635);color:#000}.fail{background:#ffffff14;color:#fff}
      table{width:100%;border-collapse:collapse;margin:12px 0}td,th{padding:8px 6px;border-bottom:1px solid #ffffff16;text-align:left}</style>
      <body><div class="wrap"><h1>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ (–¥–µ–º–æ)</h1>
      <div>–ü—Ä–æ–≤–∞–π–¥–µ—Ä: <b>${payload.provider}</b> ¬∑ –ó–∞–∫–∞–∑: <b>${payload.orderId}</b></div>
      <table><thead><tr><th>–ü–æ–∑–∏—Ü–∏—è</th><th>–¶–µ–Ω–∞</th></tr></thead><tbody>
      ${payload.items.map(i=>`<tr><td>${i.name}</td><td>${i.price} ‚ÇΩ</td></tr>`).join('')}
      </tbody></table>
      <div style="margin:10px 0">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <b>${payload.total} ‚ÇΩ</b></div>
      <a class="btn ok" href="${success}">–û–ø–ª–∞—Ç–∏—Ç—å (—É—Å–ø–µ—Ö)</a>
      <a class="btn fail" href="${fail}">–û—Ç–º–µ–Ω–∞/–æ—à–∏–±–∫–∞</a>
      <p style="opacity:.7;margin-top:16px">–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞. –ù–∞ –ø—Ä–æ–¥–µ —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è URL –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p></div></body></html>`;
      const blob = new Blob([html], {type:'text/html'});
      return URL.createObjectURL(blob);
    }

    // ======= Utils =======
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ======= Self tests (console) =======
    function selfTests(){
      try{
        console.group('%cKinostore self-tests','color:#0bf');
        console.assert(daysBetween('2025-08-01','2025-08-01')===1,'same day => 1');
        console.assert(daysBetween('2025-08-01','2025-08-03')===3,'3 days');
        console.assert(rub(1000).includes('‚ÇΩ'),'rub currency symbol');
        const payload = buildPaymentPayload({items:[{title:'X',priceDay:1}], total:1});
        console.assert(/^KIN-/.test(payload.orderId),'order id');
        console.groupEnd();
      }catch(e){ console.error('Self-tests failed', e); }
    }
  </script>
</body>
</html>
